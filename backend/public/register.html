<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro - Kuro Fidelización</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    * {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #f5f5f5;
      min-height: 100vh;
    }
    .kuro-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .kuro-input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f5f5f5;
    }
    .kuro-input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #d4af37;
      outline: none;
    }
    .kuro-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .kuro-button {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #1a1a1a;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .kuro-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(212, 175, 55, 0.3);
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>
</head>
<body>
  <div class="container mx-auto px-4 py-8 max-w-md">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">
        Registro
      </h1>
      <p class="text-gray-300">Crea tu tarjeta de fidelización</p>
    </div>

    <div class="kuro-card rounded-xl p-6 shadow-2xl">
      <form id="registerForm" class="space-y-4">
        <div>
          <label for="fullName" class="block text-sm font-medium text-yellow-400 mb-2">Nombre Completo</label>
          <input type="text" id="fullName" name="fullName" required
                 class="kuro-input w-full px-4 py-3 rounded-lg">
        </div>

        <div>
          <label for="dni" class="block text-sm font-medium text-yellow-400 mb-2">DNI</label>
          <input type="text" id="dni" name="dni" required minlength="8"
                 class="kuro-input w-full px-4 py-3 rounded-lg" placeholder="12345678">
        </div>

        <div>
          <label for="sex" class="block text-sm font-medium text-yellow-400 mb-2">Sexo</label>
          <select id="sex" name="sex" required
                  class="kuro-input w-full px-4 py-3 rounded-lg">
            <option value="">Selecciona...</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="O">Otro</option>
          </select>
        </div>

        <div>
          <label for="birthdate" class="block text-sm font-medium text-yellow-400 mb-2">Fecha de Nacimiento</label>
          <input type="date" id="birthdate" name="birthdate" required
                 class="kuro-input w-full px-4 py-3 rounded-lg">
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-yellow-400 mb-2">Email</label>
          <input type="email" id="email" name="email" required
                 class="kuro-input w-full px-4 py-3 rounded-lg">
        </div>

        <div>
          <label for="phone" class="block text-sm font-medium text-yellow-400 mb-2">Teléfono</label>
          <input type="tel" id="phone" name="phone" required
                 class="kuro-input w-full px-4 py-3 rounded-lg">
        </div>

        <div class="flex items-center">
          <input type="checkbox" id="marketingOptIn" name="marketingOptIn"
                 class="w-4 h-4 text-yellow-400 border-gray-600 rounded focus:ring-yellow-400 bg-transparent">
          <label for="marketingOptIn" class="ml-2 text-sm text-gray-300">
            Acepto recibir promociones y notificaciones
          </label>
        </div>

        <div id="errorMessage" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
        <div id="successMessage" class="hidden bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm"></div>

        <button type="submit" class="kuro-button w-full py-3 rounded-lg text-lg">
          Registrarse
        </button>
      </form>

      <div class="mt-4 text-center">
        <a href="/index.html" class="text-yellow-400 text-sm hover:text-yellow-300 underline">Volver al inicio</a>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      const formData = {
        fullName: document.getElementById('fullName').value.trim(),
        dni: document.getElementById('dni').value.trim(),
        sex: document.getElementById('sex').value,
        birthdate: document.getElementById('birthdate').value,
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        marketingOptIn: document.getElementById('marketingOptIn').checked
      };

      // Basic validation
      if (!formData.fullName || formData.fullName.length < 2) {
        errorDiv.textContent = 'El nombre debe tener al menos 2 caracteres';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (!formData.dni || formData.dni.length < 8) {
        errorDiv.textContent = 'DNI válido es requerido (mínimo 8 caracteres)';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (!formData.sex) {
        errorDiv.textContent = 'El sexo es requerido';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (!formData.birthdate) {
        errorDiv.textContent = 'La fecha de nacimiento es requerida';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (!formData.email || !formData.email.includes('@')) {
        errorDiv.textContent = 'Email válido es requerido';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (!formData.phone || formData.phone.length < 8) {
        errorDiv.textContent = 'Teléfono válido es requerido';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch('/api/customers/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          // Si es 409 (CONFLICT), mostrar mensaje específico del campo
          if (response.status === 409) {
            const message = data.message || data.error || 'Este dato ya está registrado';
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Resaltar el campo específico si existe
            if (data.field) {
              const fieldInput = document.getElementById(data.field);
              if (fieldInput) {
                fieldInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                setTimeout(() => {
                  fieldInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                }, 3000);
              }
            }
            return;
          }
          
          // Si es 503 y se auto-inicializó, pedir al usuario que recargue
          if (response.status === 503 && data.autoInitialized) {
            errorDiv.textContent = 'La base de datos se ha inicializado. Por favor, recarga la página e intenta de nuevo.';
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
              window.location.reload();
            }, 2000);
            return;
          }
          
          throw new Error(data.error || data.message || 'Error al registrar');
        }

        // Save token
        localStorage.setItem('customerToken', data.token);
        localStorage.setItem('qrToken', data.qrToken);

        successDiv.textContent = '✅ Registro exitoso. Redirigiendo...';
        successDiv.classList.remove('hidden');

        setTimeout(() => {
          window.location.href = '/dashboard.html';
        }, 1500);
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
